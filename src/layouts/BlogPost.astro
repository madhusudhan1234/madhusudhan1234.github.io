---
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import CodeMirror from "../components/CodeMirror.astro";

type Props = CollectionEntry<"blog">["data"];

const { title, description, pubDate, updatedDate, heroImage } = Astro.props;
const rawTags = (Astro.props as any)?.tags ?? "";
const tagList: string[] =
	typeof rawTags === "string"
		? rawTags
				.split(",")
				.map((t) => t.trim())
				.filter(Boolean)
		: Array.isArray(rawTags)
			? rawTags
			: [];
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} image={heroImage ? `/${heroImage}` : undefined} />
	</head>

	<body class="bg-[var(--navy)] text-[var(--slate)] font-sans antialiased">
		<Header />
		<main class="w-full max-w-4xl mx-auto px-4 pt-[110px] pb-12">
			<script type="application/ld+json">
				{JSON.stringify({
					'@context': 'https://schema.org',
					'@type': 'Article',
					'headline': title,
					'description': description,
					'image': heroImage ? `/${heroImage}` : undefined,
					'datePublished': (Astro.props as any).pubDate?.toISOString?.() || undefined,
					'dateModified': (Astro.props as any).updatedDate?.toISOString?.() || undefined,
					'author': {
						'@type': 'Person',
						'name': 'Madhu Sudhan Subedi',
					},
					'publisher': {
						'@type': 'Organization',
						'name': 'Madhu Sudhan Subedi',
						'logo': {
							'@type': 'ImageObject',
							'url': '/apple-touch-icon.png'
						}
					},
					'mainEntityOfPage': {
						'@type': 'WebPage',
						'@id': Astro.url
					}
				})}
			</script>
			<article>
				<div class="w-full mb-8">
					{
						heroImage && (
							<img
								width={1020}
								height={510}
								src={`/${heroImage}`}
								alt={title}
                                class="block mx-auto rounded-xl shadow-[var(--box-shadow)] w-full h-auto"
								loading="lazy"
								decoding="async"
							/>
						)
					}
				</div>
				<div class="w-full max-w-[720px] mx-auto p-4 text-[var(--light-slate)]">
					<div class="text-center mb-4 py-4 leading-none">
						<div class="mb-2 text-[var(--slate)]">
							<FormattedDate date={pubDate} />
							{
								updatedDate && (
									<div class="italic">
										Last updated on{" "}
										<FormattedDate date={updatedDate} />
									</div>
								)
							}
						</div>
						<h1 class="mb-2 text-[var(--lightest-slate)] text-2xl md:text-4xl font-bold">{title}</h1>
						<hr class="border-[var(--lightest-navy)] my-8" />
					</div>
					<div class="prose prose-invert prose-lg max-w-none 
                        prose-headings:text-[var(--lightest-slate)] prose-headings:font-bold 
                        prose-p:text-[var(--slate)] prose-p:leading-relaxed 
                        prose-a:text-[var(--green)] prose-a:no-underline hover:prose-a:underline
                        prose-strong:text-[var(--lightest-slate)]
                        prose-code:text-[var(--green)] prose-code:font-mono prose-code:bg-[var(--light-navy)] prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:before:content-none prose-code:after:content-none
                        prose-pre:bg-[var(--light-navy)] prose-pre:text-[var(--slate)] prose-pre:border prose-pre:border-[var(--lightest-navy)] prose-pre:rounded-lg
                        prose-li:text-[var(--slate)]
                        prose-table:border-collapse prose-table:border prose-table:border-[var(--lightest-navy)] prose-table:w-full prose-table:my-8
                        prose-th:border prose-th:border-[var(--lightest-navy)] prose-th:bg-[var(--light-navy)] prose-th:text-[var(--lightest-slate)] prose-th:p-3 prose-th:text-left
                        prose-td:border prose-td:border-[var(--lightest-navy)] prose-td:text-[var(--slate)] prose-td:p-3
                        prose-img:rounded-xl prose-img:shadow-xl
                        prose-hr:border-[var(--lightest-navy)]
                        prose-blockquote:border-l-[var(--green)] prose-blockquote:text-[var(--light-slate)] prose-blockquote:bg-[var(--light-navy)]/30 prose-blockquote:py-2 prose-blockquote:px-4 prose-blockquote:rounded-r">
					    <slot />
                    </div>
					{
						tagList.length > 0 && (
							<div class="mt-8 pt-4 border-t border-[var(--lightest-navy)] flex gap-2 flex-wrap items-center" aria-label="Tags">
								<span class="bg-[var(--light-navy)] text-[var(--green)] px-2 py-1 rounded text-xs font-mono">Tags:</span>
								{tagList.map((t) => (
									<a href={`/notes/tag/${t}`} class="bg-[var(--light-navy)] text-[var(--green)] px-2 py-1 rounded text-xs font-mono no-underline hover:underline">
										#{t}
									</a>
								))}
							</div>
						)
					}
				</div>
			</article>
		</main>
		<Footer />
		<CodeMirror />
	</body>
</html>
