---
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../../consts";
import { getCollection } from "astro:content";
import FormattedDate from "../../components/FormattedDate.astro";

const posts: any[] = (await getCollection("notes" as any)).sort(
  (a: any, b: any) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const groupedByFolder: Record<string, any[]> = posts.reduce(
  (acc: Record<string, any[]>, post: any) => {
    const parts = String(post.id).split("/");
    const folder = parts.length > 1 ? parts[0] : "misc";
    if (!acc[folder]) acc[folder] = [];
    acc[folder].push(post);
    return acc;
  },
  {},
);

const folderNames = Object.keys(groupedByFolder).sort((a, b) =>
  a.localeCompare(b),
);

const formatFolderName = (name: string) =>
  name === "misc"
    ? "Misc"
    : name
        .split(/[-_/]/)
        .filter(Boolean)
        .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
        .join(" ");
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead
      title={`Notes | My Personal Notes`}
      description={`My personal notes`}
    />
  </head>
  <body class="bg-[var(--navy)] text-[var(--slate)] font-sans antialiased">
    <Header />
    <main class="w-full max-w-6xl mx-auto px-6 md:px-12 pt-[110px] pb-12">
      <div class="mb-12">
        <h1
          class="text-3xl md:text-5xl font-bold text-[var(--lightest-slate)] mb-6"
        >
          Notes
        </h1>
        <p class="text-[var(--slate)] text-lg max-w-2xl">My personal notes.</p>
      </div>

      <section class="space-y-10">
        {
          folderNames.map((folder) => {
            const items = groupedByFolder[folder].sort(
              (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
            );
            return (
              <div>
                <h2 class="text-2xl md:text-3xl font-bold text-[var(--lightest-slate)] mb-4">
                  {formatFolderName(folder)}
                </h2>
                <ul class="space-y-3">
                  {items.map((post) => (
                    <li class="flex items-start justify-between gap-4 p-4 bg-[var(--light-navy)] rounded-lg hover:bg-[var(--lightest-navy)] transition-colors">
                      <div class="flex-1">
                        <a
                          href={`/notes/${post.id}/`}
                          class="text-[var(--lightest-slate)] font-semibold hover:text-[var(--green)]"
                        >
                          {post.data.title}
                        </a>
                        {post.data.description && (
                          <p class="text-[var(--slate)] text-sm mt-1">
                            {post.data.description}
                          </p>
                        )}
                      </div>
                      <div class="text-[var(--light-slate)] text-xs font-mono whitespace-nowrap">
                        <FormattedDate date={post.data.pubDate} />
                      </div>
                    </li>
                  ))}
                </ul>
              </div>
            );
          })
        }
      </section>
    </main>
    <Footer />
  </body>
</html>
